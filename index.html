<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mirix | Minecraft Messenger</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --m-green: #388e3c;
            --m-dirt: #5d4037;
            --m-stone: #7b7b7b;
            --m-bg: #1e1e1e;
            --m-border: #000000;
            --m-text: #f7e692;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--m-bg);
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
            color: white;
            font-family: 'Press Start 2P', cursive;
            height: 100vh;
            overflow: hidden;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–ò */
        @keyframes block-in {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* –õ–û–ì–û–¢–ò–ü MIRIX */
        .logo-box {
            display: flex; align-items: center; justify-content: center;
            padding: 20px; background: var(--m-dirt);
            border-bottom: 4px solid var(--m-border);
        }
        .logo-icon {
            width: 40px; height: 40px; background: var(--m-green);
            border: 4px solid #fff; position: relative; margin-right: 15px;
        }
        .logo-icon::after {
            content: ''; position: absolute; inset: 5px; border: 4px solid #fff;
        }

        /* –ì–õ–ê–í–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† */
        #app {
            display: grid;
            grid-template-columns: 80px 250px 1fr;
            height: 100vh;
        }

        /* –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –°–ï–†–í–ï–†–û–í */
        .servers {
            background: #111;
            border-right: 4px solid var(--m-border);
            display: flex; flex-direction: column; align-items: center;
            padding-top: 15px; gap: 15px;
        }
        .server-icon {
            width: 50px; height: 50px; background: var(--m-stone);
            border: 4px solid var(--m-border); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative;
        }
        .server-icon:hover { border-color: var(--m-green); transform: translateX(5px); }
        .server-icon.active { border-color: var(--m-green); background: var(--m-green); }

        /* –°–ü–ò–°–û–ö –ß–ê–¢–û–í */
        .chat-list {
            background: #2c2c2c;
            border-right: 4px solid var(--m-border);
            display: flex; flex-direction: column;
        }
        .list-header { padding: 15px; font-size: 10px; color: var(--m-text); border-bottom: 2px solid #111; }
        .contact {
            padding: 15px; font-size: 8px; cursor: pointer;
            border-bottom: 2px solid #111; transition: 0.3s;
        }
        .contact:hover { background: var(--m-dirt); }

        /* –û–ö–ù–û –ß–ê–¢–ê */
        .main-chat {
            display: flex; flex-direction: column;
            background: #333;
            position: relative;
        }
        .chat-header {
            padding: 15px; background: var(--m-stone);
            border-bottom: 4px solid var(--m-border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .messages {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .msg {
            max-width: 70%; padding: 10px; font-size: 8px;
            line-height: 1.5; position: relative; animation: block-in 0.3s ease;
        }
        .msg-me { align-self: flex-end; background: var(--m-green); border: 3px solid #1b5e20; }
        .msg-them { align-self: flex-start; background: var(--m-stone); border: 3px solid #444; }

        .chat-input-area {
            padding: 20px; background: #222; border-top: 4px solid var(--m-border);
            display: flex; gap: 10px;
        }
        input {
            flex: 1; background: #000; border: 3px solid var(--m-stone);
            color: #fff; padding: 10px; font-family: 'Press Start 2P'; font-size: 10px;
        }
        .btn {
            background: var(--m-green); border: 4px solid #1b5e20;
            color: white; padding: 10px 15px; cursor: pointer;
            font-family: 'Press Start 2P'; font-size: 8px;
            box-shadow: inset -4px -4px 0 rgba(0,0,0,0.3);
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-call { background: #ff9800; border-color: #e65100; }
        .btn-screen { background: #2196f3; border-color: #0d47a1; }

        /* –û–ö–ù–û –ó–í–û–ù–ö–ê */
        #call-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 1000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        #screen-video { width: 80%; border: 8px solid var(--m-stone); background: #000; margin-top: 20px; }

        /* –ú–û–î–ê–õ–ö–ò */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-content {
            background: var(--m-dirt); border: 6px solid var(--m-border);
            padding: 30px; width: 400px; text-align: center;
        }

        @media (max-width: 800px) {
            #app { grid-template-columns: 60px 1fr; }
            .chat-list { display: none; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –°–µ—Ä–≤–µ—Ä–æ–≤ -->
    <div class="servers">
        <div class="server-icon active" title="–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã">üë§</div>
        <div class="server-icon" onclick="openFriendModal()" title="–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞">‚ûï</div>
        <div id="group-list"></div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    <div class="chat-list">
        <div class="logo-box">
            <div class="logo-icon"></div>
            <div style="font-size: 12px; color: var(--m-text);">mirix</div>
        </div>
        <div class="list-header">–î–†–£–ó–¨–Ø</div>
        <div id="contacts-area"></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <div class="main-chat">
        <div class="chat-header">
            <div id="current-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-call" onclick="startCall(false)">üìû –ó–í–û–ù–û–ö</button>
                <button class="btn btn-screen" onclick="startCall(true)">üì∫ –≠–ö–†–ê–ù</button>
            </div>
        </div>

        <div class="messages" id="messages-window">
            <div class="msg msg-them">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ mirix! –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∞ –ø–æ ID, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.</div>
        </div>

        <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="btn" onclick="sendMessage()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        </div>
    </div>
</div>

<!-- –û–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ / —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ -->
<div id="call-overlay">
    <h2 id="call-status">–¢–†–ê–ù–°–õ–Ø–¶–ò–Ø...</h2>
    <video id="screen-video" autoplay playsinline></video>
    <div style="margin-top: 20px;">
        <button class="btn" style="background: #f44336;" onclick="endCall()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞ -->
<div id="friend-modal" class="modal">
    <div class="modal-content">
        <h3 style="color: var(--m-text);">–î–û–ë–ê–í–ò–¢–¨ –î–†–£–ì–ê</h3>
        <p style="font-size: 8px;">–í–ê–® ID: <span id="my-id" style="color: var(--m-green);">...</span></p>
        <input type="text" id="friend-id-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞">
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="btn" onclick="sendFriendRequest()">–û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–ü–†–û–°</button>
            <button class="btn" style="background: var(--m-stone);" onclick="closeFriendModal()">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>
</div>

<script>
    /** --- –ù–ê–°–¢–†–û–ô–ö–ò MIRIX --- **/
    const RENDER_SERVER = 'my-peer-server-cvoj.onrender.com'; // –¢–≤–æ–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ Render

    let peer, myId;
    let friends = JSON.parse(localStorage.getItem('mirix_friends') || '[]');
    let currentChatId = null;
    let localStream, currentCall;

    function initMirix() {
        const sid = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer('mx-' + sid, {
            host: RENDER_SERVER, port: 443, path: '/myapp', secure: true
        });

        peer.on('open', id => {
            myId = id.split('-')[1];
            document.getElementById('my-id').innerText = myId;
            renderFriends();
        });

        // –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∑–∞–ø—Ä–æ—Å—ã
        peer.on('connection', conn => {
            conn.on('data', data => {
                if(data.type === 'FRIEND_REQ') {
                    if(confirm(`–ò–≥—Ä–æ–∫ ${data.from} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å—Å—è –≤ –¥—Ä—É–∑—å—è. –ü—Ä–∏–Ω—è—Ç—å?`)) {
                        addFriend(data.from);
                    }
                }
                if(data.type === 'TEXT') {
                    receiveMessage(data.from, data.text);
                }
            });
        });

        // –í—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏/—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
        peer.on('call', call => {
            if(confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫/—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è. –ü—Ä–∏–Ω—è—Ç—å?")) {
                call.answer();
                setupMediaStream(call);
            }
        });
    }

    /** --- –ß–ê–¢ –ò –°–û–û–ë–©–ï–ù–ò–Ø --- **/
    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value;
        if(!text || !currentChatId) return;

        const conn = peer.connect('mx-' + currentChatId);
        conn.on('open', () => {
            conn.send({ type: 'TEXT', from: myId, text: text });
            addMessageToWindow('–í—ã', text, 'msg-me');
            input.value = '';
        });
    }

    function receiveMessage(from, text) {
        if(currentChatId === from) {
            addMessageToWindow(from, text, 'msg-them');
        } else {
            alert(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${from}`);
        }
    }

    function addMessageToWindow(user, text, style) {
        const win = document.getElementById('messages-window');
        const div = document.createElement('div');
        div.className = `msg ${style}`;
        div.innerText = text;
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    /** --- –î–†–£–ó–¨–Ø --- **/
    function openFriendModal() { document.getElementById('friend-modal').style.display = 'flex'; }
    function closeFriendModal() { document.getElementById('friend-modal').style.display = 'none'; }

    function sendFriendRequest() {
        const fid = document.getElementById('friend-id-input').value;
        if(!fid || fid === myId) return;
        const conn = peer.connect('mx-' + fid);
        conn.on('open', () => {
            conn.send({ type: 'FRIEND_REQ', from: myId });
            alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            addFriend(fid);
            closeFriendModal();
        });
    }

    function addFriend(id) {
        if(!friends.includes(id)) {
            friends.push(id);
            localStorage.setItem('mirix_friends', JSON.stringify(friends));
            renderFriends();
        }
    }

    function renderFriends() {
        const area = document.getElementById('contacts-area');
        area.innerHTML = '';
        friends.forEach(id => {
            const div = document.createElement('div');
            div.className = 'contact';
            div.innerText = `PLAYER_${id}`;
            div.onclick = () => selectChat(id);
            area.appendChild(div);
        });
    }

    function selectChat(id) {
        currentChatId = id;
        document.getElementById('current-chat-name').innerText = `–ß–ê–¢: PLAYER_${id}`;
        document.getElementById('messages-window').innerHTML = '';
        addMessageToWindow('–°–∏—Å—Ç–µ–º–∞', `–í—ã –Ω–∞—á–∞–ª–∏ —á–∞—Ç —Å ${id}`, 'msg-them');
    }

    /** --- –ó–í–û–ù–ö–ò –ò –¢–†–ê–ù–°–õ–Ø–¶–ò–Ø –≠–ö–†–ê–ù–ê --- **/
    async function startCall(isScreen) {
        if(!currentChatId) return;
        
        try {
            if(isScreen) {
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            } else {
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
            }

            document.getElementById('call-overlay').style.display = 'flex';
            const call = peer.call('mx-' + currentChatId, localStream);
            setupMediaStream(call);
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É/—ç–∫—Ä–∞–Ω—É");
        }
    }

    function setupMediaStream(call) {
        currentCall = call;
        const video = document.getElementById('screen-video');
        
        call.on('stream', remoteStream => {
            document.getElementById('call-overlay').style.display = 'flex';
            video.srcObject = remoteStream;
        });

        call.on('close', endCall);
    }

    function endCall() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        if(currentCall) currentCall.close();
        document.getElementById('call-overlay').style.display = 'none';
    }

    window.onload = initMirix;
</script>
</body>
</html>
