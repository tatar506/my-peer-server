<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mirix | Private Messenger</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --accent: #007AFF; 
            --bg-gradient: linear-gradient(135deg, #1d1d1f 0%, #434343 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body, html {
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: white;
            overflow: hidden;
        }

        /* –≠–§–§–ï–ö–¢ –°–¢–ï–ö–õ–ê */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò */
        #auth-screen {
            position: fixed; inset: 0;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; background: var(--bg-gradient);
            padding: 20px; transition: 0.5s ease;
        }

        .auth-card {
            width: 100%; max-width: 400px;
            padding: 40px; text-align: center;
        }

        .logo-img {
            width: 100px; height: 100px;
            border-radius: 24px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            object-fit: cover;
        }

        input {
            width: 100%; background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px;
            color: white; margin-bottom: 15px;
            font-size: 16px; transition: 0.3s;
        }

        input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }

        .btn {
            width: 100%; padding: 15px;
            border-radius: 12px; border: none;
            background: var(--accent); color: white;
            font-size: 16px; font-weight: 600;
            cursor: pointer; transition: 0.3s;
        }

        /* –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #main-app {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh; width: 100vw;
            padding: 20px; gap: 20px;
            display: none;
        }

        .sidebar { display: flex; flex-direction: column; gap: 20px; }

        .profile-card { padding: 20px; display: flex; align-items: center; gap: 15px; }

        .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--accent); display: flex;
            align-items: center; justify-content: center; font-weight: bold;
        }

        .contact-list { flex: 1; overflow-y: auto; padding: 10px; }

        .contact-item {
            padding: 15px; border-radius: 15px;
            margin-bottom: 10px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .contact-item:hover { background: rgba(255,255,255,0.1); }

        .chat-window { display: flex; flex-direction: column; overflow: hidden; }

        .chat-header {
            padding: 20px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--glass-border);
        }

        .messages {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
        }

        .bubble {
            max-width: 75%; padding: 12px 18px; border-radius: 20px;
            font-size: 15px; line-height: 1.4;
        }
        .me { align-self: flex-end; background: var(--accent); }
        .them { align-self: flex-start; background: rgba(255,255,255,0.15); }

        .input-bar { padding: 20px; display: flex; gap: 10px; }

        /* –ó–í–û–ù–ö–ò */
        #call-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 2000; display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        video { width: 90%; max-width: 900px; border-radius: 24px; border: 1px solid var(--glass-border); }

        @media (max-width: 768px) {
            #main-app { grid-template-columns: 1fr; padding: 10px; }
            .sidebar { display: none; }
        }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
    <div id="auth-screen">
        <div class="auth-card glass-panel">
            <img src="https://i127.fastpic.org/thumb/2026/0211/d2/_d9953a8a86111b05c17efa7f3401c5d2.jpeg" class="logo-img" alt="mirix">
            <h2>mirix Messenger</h2>
            <input type="text" id="username" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="handleAuth()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="main-app">
        <div class="sidebar glass-panel">
            <div class="profile-card">
                <div class="avatar" id="my-avatar">?</div>
                <div>
                    <div id="my-name" style="font-weight: 600;">Username</div>
                    <div id="my-id-tag" style="font-size: 12px; opacity: 0.5;">ID: ....</div>
                </div>
            </div>
            <div style="padding: 0 20px;">
                <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="addFriend()">+ –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
            </div>
            <div class="contact-list" id="contact-list"></div>
        </div>

        <div class="chat-window glass-panel">
            <div class="chat-header">
                <div id="chat-title" style="font-weight: 600;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="width: 50px;" onclick="makeCall(false)">üìû</button>
                    <button class="btn" style="width: 50px; background: #34C759;" onclick="makeCall(true)">üì∫</button>
                </div>
            </div>
            <div class="messages" id="msg-container"></div>
            <div class="input-bar">
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin: 0;">
                <button class="btn" style="width: 60px;" onclick="sendText()">></button>
            </div>
        </div>
    </div>

    <!-- –ó–í–û–ù–û–ö -->
    <div id="call-screen">
        <video id="remote-video" autoplay playsinline></video>
        <button class="btn" style="width: 200px; margin-top: 20px; background: #FF3B30;" onclick="endCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

<script>
    /************************************************************/
    /*  –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê (–í–°–¢–ê–í–¨ –°–í–û–ô –ê–î–†–ï–° –¢–£–¢)               */
    /************************************************************/
    const RENDER_HOST = 'my-peer-server-cvoj.onrender.com'; 
    const RENDER_PATH = '/myapp'; // –ü—É—Ç—å, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —É–∫–∞–∑–∞–ª –≤ package.json –Ω–∞ Render
    /************************************************************/

    let peer, myId, currentUser;
    let friends = JSON.parse(localStorage.getItem('mirix_friends') || '[]');
    let activeChatId = null;
    let localStream, currentCall;

    // –í—Ö–æ–¥
    function handleAuth() {
        const name = document.getElementById('username').value;
        if (name.length < 2) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
        currentUser = { name };
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'grid';
        initPeer();
    }

    // –°–µ—Ç—å
    function initPeer() {
        const sid = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer('mx-' + sid, {
            host: RENDER_HOST, 
            port: 443, 
            path: RENDER_PATH, 
            secure: true
        });

        peer.on('open', id => {
            myId = id.split('-')[1];
            document.getElementById('my-name').innerText = currentUser.name;
            document.getElementById('my-id-tag').innerText = "ID: " + myId;
            document.getElementById('my-avatar').innerText = currentUser.name[0].toUpperCase();
            renderFriends();
        });

        peer.on('connection', c => {
            c.on('data', data => {
                if(data.type === 'CHAT') appendMsg(data.text, 'them');
                if(data.type === 'ADD') confirmFriend(data.from, data.name);
            });
        });

        peer.on('call', call => {
            if(confirm("–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤/—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è. –ü—Ä–∏–Ω—è—Ç—å?")) {
                call.answer();
                handleStream(call);
            }
        });
    }

    function addFriend() {
        const id = prompt("–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞:");
        if(!id) return;
        const c = peer.connect('mx-' + id);
        c.on('open', () => {
            c.send({ type: 'ADD', from: myId, name: currentUser.name });
            alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
        });
    }

    function confirmFriend(id, name) {
        if(confirm(`–î–æ–±–∞–≤–∏—Ç—å ${name} (ID: ${id}) –≤ –¥—Ä—É–∑—å—è?`)) {
            if(!friends.find(f => f.id === id)) {
                friends.push({id, name});
                localStorage.setItem('mirix_friends', JSON.stringify(friends));
                renderFriends();
            }
        }
    }

    function renderFriends() {
        const list = document.getElementById('contact-list');
        list.innerHTML = '';
        friends.forEach(f => {
            const el = document.createElement('div');
            el.className = 'contact-item glass-panel';
            el.innerHTML = `<div class="avatar" style="width:30px; height:30px; font-size:12px;">${f.name[0]}</div> <span>${f.name}</span>`;
            el.onclick = () => { activeChatId = f.id; document.getElementById('chat-title').innerText = f.name; };
            list.appendChild(el);
        });
    }

    function sendText() {
        const input = document.getElementById('msg-input');
        if(!input.value || !activeChatId) return;
        const c = peer.connect('mx-' + activeChatId);
        c.on('open', () => {
            c.send({ type: 'CHAT', text: input.value });
            appendMsg(input.value, 'me');
            input.value = '';
        });
    }

    function appendMsg(text, type) {
        const container = document.getElementById('msg-container');
        const div = document.createElement('div');
        div.className = `bubble ${type}`;
        div.innerText = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    async function makeCall(isScreen) {
        if(!activeChatId) return;
        try {
            localStream = isScreen ? 
                await navigator.mediaDevices.getDisplayMedia({video:true}) : 
                await navigator.mediaDevices.getUserMedia({audio:true});
            const call = peer.call('mx-' + activeChatId, localStream);
            handleStream(call);
        } catch (e) { alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞"); }
    }

    function handleStream(call) {
        currentCall = call;
        document.getElementById('call-screen').style.display = 'flex';
        call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
    }

    function endCall() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-screen').style.display = 'none';
    }
</script>
</body>
</html>
