<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TERRA-LINK: Fixed Connection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #5aa2e2; overflow: hidden; font-family: 'Press Start 2P', cursive; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 100; text-align: center; }
        .panel { background: #5d4037; border: 4px solid #3d2a1f; color: #f7e692; padding: 15px; pointer-events: auto; display: inline-block; margin-top: 20%; }
        .btn { background: #5ea74d; border: 3px solid #36612a; color: white; padding: 10px; width: 100%; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px; }
        #chat { position: absolute; bottom: 120px; left: 10px; width: 200px; height: 100px; background: rgba(0,0,0,0.5); color: white; font-size: 8px; overflow-y: auto; padding: 5px; text-align: left; }
        .ctrl-btn { position: absolute; bottom: 20px; width: 80px; height: 80px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 50%; pointer-events: auto; }
    </style>
</head>
<body>

<div id="ui">
    <div id="menu" class="panel">
        <h3>TERRA-LINK</h3>
        <p id="my-id" style="font-size: 8px;">ПОДКЛЮЧЕНИЕ К СЕРВЕРУ...</p>
        <input type="text" id="friend-id" placeholder="ID ДРУГА" style="margin-bottom: 10px; width: 80%;">
        <button class="btn" onclick="join()">ИГРАТЬ С ДРУГОМ</button>
    </div>
    <div id="chat">Чат активен...<br></div>
    <div id="l-btn" class="ctrl-btn" style="left: 20px;"></div>
    <div id="r-btn" class="ctrl-btn" style="right: 20px;"></div>
</div>

<script>
// --- ЗАМЕНИ ЭТУ ССЫЛКУ НА СВОЮ ИЗ RENDER ---
const MY_RENDER_URL = 'my-peer-server.onrender.com'; 

let peer, conn, player, partner, scene;

function initPeer() {
    const sid = Math.floor(1000 + Math.random() * 9000).toString();
    
    // Используем ваш личный сервер вместо заблокированного 0.peerjs.com
    peer = new Peer('t-' + sid, {
        host: MY_RENDER_URL,
        port: 443,
        path: '/myapp',
        secure: true,
        debug: 3
    });

    peer.on('open', id => {
        document.getElementById('my-id').innerText = "ВАШ ID: " + id.split('-')[1];
        console.log("Connected to private server!");
    });

    peer.on('connection', c => { conn = c; setupConn(); });
    
    peer.on('error', err => {
        console.error("PeerJS Error:", err.type);
        if(err.type === 'server-error') alert("Сервер Render еще просыпается. Подождите 30 секунд.");
    });
}

function join() {
    const fid = document.getElementById('friend-id').value;
    conn = peer.connect('t-' + fid);
    setupConn();
}

function setupConn() {
    conn.on('open', () => {
        document.getElementById('menu').style.display = 'none';
        startWorld();
    });
    conn.on('data', data => { if(data.type === 'sync') syncPartner(data.s); });
}

/** --- ИГРА --- **/
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'matter', matter: { gravity: { y: 1 } } },
    scene: { preload: preload, create: create, update: update }
};
const game = new Phaser.Game(config);

function preload() {
    scene = this;
    let g = this.make.graphics({x:0,y:0,add:false});
    g.fillStyle(0x5d4037, 1); g.fillRect(0,0,40,40);
    g.generateTexture('block', 40, 40);
    g.clear();
    g.fillStyle(0x00ff00, 1); g.fillRect(0,0,20,30);
    g.generateTexture('p1', 20, 30);
}

function create() {
    this.matter.world.setBounds(0, 0, 5000, 2000);
    initPeer();
    for(let i=0; i<100; i++) this.matter.add.image(i*40, 600, 'block', null, {isStatic:true});
}

function startWorld() {
    player = scene.matter.add.image(200, 500, 'p1').setRectangle(20, 30).setFriction(0.5);
    partner = scene.add.rectangle(0, 0, 20, 30, 0xff0000);
    scene.cameras.main.startFollow(player);
}

function update() {
    if(!player || !conn) return;

    // Простое управление тапом для теста
    if(this.input.activePointer.isDown) {
        const p = this.input.activePointer;
        player.applyForce({x: (p.worldX - player.x) * 0.0005, y: -0.002});
    }

    conn.send({type:'sync', s: {x: player.x, y: player.y, r: player.rotation}});
}

function syncPartner(s) {
    if(!partner) return;
    partner.x = s.x; partner.y = s.y; partner.rotation = s.r;
}
</script>
</body>
</html>