<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GLOW-BOUND: Cross-Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00ff9d; --pink: #ff0077; --brown: #3d2a1f; }
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Press Start 2P', cursive; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        .pointer { pointer-events: auto; }
        
        /* Меню Хаба */
        .panel { background: var(--brown); border: 4px solid #2a1d15; color: #f7e692; padding: 15px; box-shadow: 6px 6px 0 rgba(0,0,0,0.5); }
        #lobby { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; text-align: center; }
        
        #clan-box { margin: 10px 0; background: #1a1a1a; height: 120px; overflow-y: auto; text-align: left; padding: 5px; border: 2px solid #000; font-size: 8px; }
        .clan-item { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 3px; }

        .btn { background: #5ea74d; border: 3px solid #36612a; color: white; padding: 10px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 8px; width: 100%; margin: 5px 0; }
        input { width: 85%; background: #000; border: 2px solid var(--neon); color: #fff; padding: 8px; font-size: 10px; font-family: 'Press Start 2P'; }

        /* HUD */
        #chat-ui { position: absolute; bottom: 120px; left: 10px; width: 200px; height: 100px; display: none; background: rgba(0,0,0,0.7); padding: 5px; color: #fff; font-size: 8px; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; }

        /* Инструкция для ПК */
        #pc-help { position: absolute; top: 10px; right: 10px; color: #fff; font-size: 7px; text-align: right; line-height: 1.5; }

        /* Мобильные кнопки */
        .mobile-ctrl { position: absolute; bottom: 20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 2px solid #fff; border-radius: 50%; display: none; }
        .grab-btn { position: absolute; bottom: 110px; width: 50px; height: 50px; background: var(--pink); border-radius: 10px; border: 2px solid #fff; display: none; align-items: center; justify-content: center; font-size: 8px; color: #fff; }

        #sms { position: absolute; top: -100px; left: 50%; transform: translateX(-50%); background: #fff; border: 3px solid var(--pink); padding: 10px; font-size: 8px; transition: 0.5s; }
    </style>
</head>
<body>

<div id="ui">
    <div id="lobby" class="panel pointer">
        <h2 style="font-size: 12px; margin-bottom: 15px;">GLOW-BOUND HUB</h2>
        <p id="my-id-label" style="font-size: 8px; color: var(--neon);">CONNECTING...</p>
        
        <div id="clan-box">
            <div style="opacity: 0.5;">Ваш список пуст...</div>
        </div>

        <input type="text" id="target-id" placeholder="ID ИГРОКА">
        <button class="btn" onclick="addFriend()">ДОБАВИТЬ В КЛАН</button>
        <button class="btn" style="background:#4d70a7" onclick="copyMyId()">КОПИРОВАТЬ МОЙ ID</button>
    </div>

    <div id="pc-help">
        ПК УПРАВЛЕНИЕ:<br>
        A, D - ХОДЬБА<br>
        Q, E - ЗАХВАТ РУКАМИ<br>
        МЫШЬ - НАПРАВЛЕНИЕ РУК
    </div>

    <div id="sms" class="pointer">
        <div id="sms-msg">ВХОДЯЩИЙ ЗАПРОС</div>
        <button class="btn" style="width: auto; margin-top: 5px;" onclick="acceptInvite()">ПРИНЯТЬ</button>
    </div>

    <div id="chat-ui" class="pointer">
        <div id="messages"></div>
        <input type="text" id="chat-in" placeholder="ТЕКСТ...">
    </div>

    <!-- Мобилки -->
    <div id="joy-l" class="mobile-ctrl pointer" style="left: 20px;"></div>
    <div id="joy-r" class="mobile-ctrl pointer" style="right: 20px;"></div>
    <div id="btn-l" class="grab-btn pointer" style="left: 35px;">L-GRB</div>
    <div id="btn-r" class="grab-btn pointer" style="right: 35px;">R-GRB</div>
</div>

<script>
/** --- NETWORKING --- **/
const MY_RENDER_HOST = 'my-peer-server-cvoj.onrender.com'; // ЗАМЕНИ НА СВОЙ!

let peer, conn, myId, player, partner, scene;
let clan = JSON.parse(localStorage.getItem('clan') || '[]');
let currentHostId = null;

function initNetwork() {
    const sid = Math.floor(1000 + Math.random() * 9000).toString();
    peer = new Peer('gb-' + sid, { host: MY_RENDER_HOST, port: 443, path: '/myapp', secure: true });

    peer.on('open', id => {
        myId = id.split('-')[1];
        document.getElementById('my-id-label').innerText = "ВАШ ID: " + myId;
        renderClan();
        if(new URLSearchParams(window.location.search).get('join')) addFriend(new URLSearchParams(window.location.search).get('join'));
    });

    peer.on('connection', c => {
        c.on('data', data => {
            if(data.type === 'INVITE') showInvite(data.from);
            if(data.type === 'SYNC') syncPartner(data.state);
        });
        conn = c;
    });

    // Проверка на тач-скрин
    if ('ontouchstart' in window) {
        document.querySelectorAll('.mobile-ctrl, .grab-btn').forEach(el => el.style.display = 'flex');
        document.getElementById('pc-help').style.display = 'none';
    }
}

function renderClan() {
    const box = document.getElementById('clan-box');
    if(clan.length === 0) return;
    box.innerHTML = '';
    clan.forEach(id => {
        box.innerHTML += `<div class="clan-item">
            ID: ${id} <button class="btn" style="width:70px; margin:0; font-size:6px;" onclick="sendInvite('${id}')">В БОЙ</button>
        </div>`;
    });
}

function addFriend(fid) {
    const id = fid || document.getElementById('target-id').value;
    if(id && id !== myId && !clan.includes(id)) {
        clan.push(id);
        localStorage.setItem('clan', JSON.stringify(clan));
        renderClan();
    }
}

function sendInvite(id) {
    const temp = peer.connect('gb-' + id);
    temp.on('open', () => {
        temp.send({ type: 'INVITE', from: myId });
        alert("Запрос отправлен игроку " + id);
    });
}

function showInvite(id) {
    currentHostId = id;
    document.getElementById('sms-msg').innerText = "ПРИГЛАШЕНИЕ ОТ " + id;
    document.getElementById('sms').style.top = "20px";
}

function acceptInvite() {
    document.getElementById('sms').style.top = "-100px";
    conn = peer.connect('gb-' + currentHostId);
    conn.on('open', () => {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('chat-ui').style.display = 'flex';
        startGame();
    });
}

function copyMyId() { navigator.clipboard.writeText(myId); alert("ID скопирован!"); }

/** --- GAME LOGIC --- **/
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth, height: window.innerHeight,
    physics: { default: 'matter', matter: { gravity: { y: 1.5 }, debug: false, enableSleeping: true } },
    scene: { preload: preload, create: create, update: update }
};
const game = new Phaser.Game(config);

function preload() {
    scene = this;
    const draw = (k, c, w, h) => {
        let g = this.make.graphics({x:0,y:0,add:false});
        g.fillStyle(c, 1); g.fillRect(0,0,w,h);
        g.generateTexture(k, w, h);
    };
    draw('tile', 0x5d4037, 40, 40); // Земля (коричневая)
    draw('grass', 0x388e3c, 40, 40); // Трава (зеленая)
    draw('p_body', 0xffffff, 20, 30);
    draw('p_hand', 0xe0a96d, 10, 10);
}

function create() {
    this.matter.world.setBounds(0, -5000, 10000, 6000);
    initNetwork();
}

function createHero(x, y, tint) {
    const M = scene.matter;
    const group = M.world.nextGroup(true);

    // Основное тело
    const body = M.add.image(x, y, 'p_body').setRectangle(20, 30).setCollisionGroup(group).setTint(tint).setFriction(0.5).setBounce(0);
    // Руки
    const lHand = M.add.image(x-25, y, 'p_hand').setCircle(5).setCollisionGroup(group).setFriction(1).setBounce(0);
    const rHand = M.add.image(x+25, y, 'p_hand').setCircle(5).setCollisionGroup(group).setFriction(1).setBounce(0);

    // Мягкие связи, чтобы персонажа не рвало
    M.add.constraint(body, lHand, 50, 0.2, { pointA: {x:-10, y:0}, stiffness: 0.1, damping: 0.05 });
    M.add.constraint(body, rHand, 50, 0.2, { pointA: {x: 10, y:0}, stiffness: 0.1, damping: 0.05 });

    // Лимит скорости (чтобы не улетал)
    body.body.velocityLimit = 10;

    return { body, lHand, rHand, grabs: [null, null] };
}

function startGame() {
    // Генерация мира (Terraria style)
    for(let i=0; i<300; i++) {
        let tx = i * 40;
        let ty = 600 + Math.sin(i * 0.2) * 60;
        scene.matter.add.image(tx, ty, 'grass', null, { isStatic: true });
        for(let j=1; j<5; j++) scene.matter.add.image(tx, ty + j*40, 'tile', null, { isStatic: true });
        
        // Препятствия
        if(i % 15 === 0) {
            for(let k=1; k<6; k++) scene.matter.add.image(tx, ty - k*40, 'tile', null, { isStatic: true });
        }
    }

    player = createHero(200, 400, 0x00ff9d);
    partner = createHero(300, 400, 0xff0077);

    scene.cameras.main.startFollow(player.body, true, 0.1, 0.1);
    scene.cameras.main.setZoom(1.3);

    setupInput();
}

/** --- INPUT & MOVEMENT --- **/
let keys;
function setupInput() {
    keys = scene.input.keyboard.addKeys('A,D,Q,E');
    
    const toggleGrab = (idx) => {
        const hand = idx === 0 ? player.lHand : player.rHand;
        const btn = idx === 0 ? document.getElementById('btn-l') : document.getElementById('btn-r');
        
        if(player.grabs[idx]) {
            scene.matter.world.removeConstraint(player.grabs[idx]);
            player.grabs[idx] = null;
            btn.style.background = 'var(--pink)';
        } else {
            const bodies = scene.matter.world.localWorld.bodies;
            for(let b of bodies) {
                if(b === player.body.body || b === player.lHand.body || b === player.rHand.body) continue;
                if(Phaser.Math.Distance.Between(hand.x, hand.y, b.position.x, b.position.y) < 30) {
                    player.grabs[idx] = scene.matter.add.constraint(hand, b, 2, 0.9);
                    btn.style.background = '#00ff00';
                    break;
                }
            }
        }
    };

    // ПК кнопки
    scene.input.keyboard.on('keydown-Q', () => toggleGrab(0));
    scene.input.keyboard.on('keydown-E', () => toggleGrab(1));
    // Мобильные кнопки
    document.getElementById('btn-l').onclick = () => toggleGrab(0);
    document.getElementById('btn-r').onclick = () => toggleGrab(1);
}

function update() {
    if(!player || !conn || !conn.open) return;

    // 1. Движение (Ходьба)
    const moveSpeed = 0.005;
    if (keys.A.isDown) player.body.applyForce({x: -moveSpeed, y: 0});
    if (keys.D.isDown) player.body.applyForce({x: moveSpeed, y: 0});

    // 2. Управление руками (Мышь / Тач)
    const pointer = scene.input.activePointer;
    const activeHand = pointer.worldX < player.body.x ? player.lHand : player.rHand;
    const forceX = (pointer.worldX - activeHand.x) * 0.0002;
    const forceY = (pointer.worldY - activeHand.y) * 0.0002;
    
    if(pointer.isDown) {
        activeHand.applyForce({x: forceX, y: forceY});
    }

    // 3. Лимит скорости (защита от багов)
    const vel = player.body.body.velocity;
    const maxV = 12;
    if(Math.abs(vel.x) > maxV) player.body.setVelocityX(maxV * Math.sign(vel.x));
    if(Math.abs(vel.y) > maxV) player.body.setVelocityY(maxV * Math.sign(vel.y));

    // 4. Синхронизация
    conn.send({
        type: 'SYNC',
        state: {
            bx: player.body.x, by: player.body.y, br: player.body.rotation,
            lx: player.lHand.x, ly: player.lHand.y,
            rx: player.rHand.x, ry: player.rHand.y
        }
    });
}

function syncPartner(s) {
    if(!partner) return;
    partner.body.setPosition(s.bx, s.by).setRotation(s.br);
    partner.lHand.setPosition(s.lx, s.ly);
    partner.rHand.setPosition(s.rx, s.ry);
}

window.addEventListener('resize', () => game.scale.resize(window.innerWidth, window.innerHeight));
</script>
</body>
</html>
